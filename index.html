<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÁáüÈÅãÂπ¥Â∫¶Á∏æÊïà - ÁæéÂä†ÈÜ´Áæé</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@0.263.1/dist/umd/lucide.min.js"></script>

    <!-- SheetJS -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <!-- html2canvas -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <!-- Firebase SDK Setup -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        
        let firebaseConfig = null;

        // 1. ÂÑ™ÂÖàÂòóË©¶ËÆÄÂèñÁí∞Â¢ÉËÆäÊï∏ (ÈñãÁôºÁí∞Â¢ÉÁî®)
        if (typeof __firebase_config !== 'undefined') {
            try {
                firebaseConfig = JSON.parse(__firebase_config);
            } catch (e) { console.warn("Env config parse error"); }
        }

        // 2. Â¶ÇÊûúÊ≤íÊúâÁí∞Â¢ÉËÆäÊï∏ (‰æãÂ¶ÇÂú® GitHub Pages)ÔºåÂâá‰ΩøÁî®ÊÇ®Êèê‰æõÁöÑË®≠ÂÆö
        // [FIXED] ÈÄôË£°Â∑≤Á∂ìÂ°´ÂÖ•ÊÇ®Êèê‰æõÁöÑÊ≠£ÂºèË®≠ÂÆöÁ¢º
        if (!firebaseConfig) {
            firebaseConfig = {
                apiKey: "AIzaSyDZkZCIk5UWBd-UnHmMCXr1BqTYZPZCkgA",
                authDomain: "megaia-medical-dashboard.firebaseapp.com",
                projectId: "megaia-medical-dashboard",
                storageBucket: "megaia-medical-dashboard.firebasestorage.app",
                messagingSenderId: "740007881577",
                appId: "1:740007881577:web:9e3d78678b484ddead6bf8",
                measurementId: "G-PT1B3BVH50"
            };
        }

        if (firebaseConfig) {
            const app = initializeApp(firebaseConfig);
            
            // Expose Firebase to window for React to use
            window.auth = getAuth(app);
            window.db = getFirestore(app);
            window.signInAnonymously = signInAnonymously;
            window.signInWithCustomToken = signInWithCustomToken;
            window.onAuthStateChanged = onAuthStateChanged;
            window.doc = doc;
            window.setDoc = setDoc;
            window.getDoc = getDoc;
            window.collection = collection;
            window.onSnapshot = onSnapshot;
            
            // App ID for data separation (Default to prod)
            window.appId = typeof __app_id !== 'undefined' ? __app_id : 'medical-dashboard-prod';
            window.__initial_auth_token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : undefined;
            
            console.log("Firebase initialized successfully.");
        } else {
            console.error("Firebase config missing. Cloud features disabled.");
        }
    </script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        medical: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                        },
                        brand: {
                            red: '#D32F2F', 
                        }
                    },
                    fontFamily: {
                        sans: ['Microsoft JhengHei', 'Heiti TC', 'Segoe UI', 'Roboto', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #f8fafc; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        
        /* Typography */
        .metric-label { 
            font-size: 0.85rem; 
            font-weight: 600; 
            color: #64748b; 
            margin-bottom: 4px;
            white-space: pre-wrap;
            line-height: 1.2;
        }
        .metric-value { 
            font-family: 'Segoe UI', sans-serif; 
            font-weight: 800; 
            color: #334155; 
            line-height: 1.1; 
        }
        
        /* Card */
        .stat-card {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .card-header {
            background: #ffffff;
            padding: 12px 16px;
            border-bottom: 1px solid #f1f5f9;
            font-size: 1rem;
            font-weight: 800;
            color: #475569;
            display: flex;
            align-items: center;
        }
        .card-content { padding: 16px; flex: 1; }

        /* Staff Section */
        .staff-section-title {
            font-size: 0.85rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 8px;
            padding-bottom: 4px;
            border-bottom: 2px solid #f1f5f9;
            color: #64748b;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            font-size: 0.9rem;
        }
        .info-label { color: #64748b; font-size: 0.8rem; font-weight: 600; }
        .info-val-container { display: flex; align-items: center; }
        .info-val { font-weight: 700; color: #334155; }
        
        /* Ranking Icons */
        .rank-icon { 
            margin-left: 8px; 
            font-size: 1.4rem; 
            line-height: 1;
            filter: drop-shadow(0px 1px 1px rgba(0,0,0,0.2));
        }

        /* Global Sales Rank Badge */
        .global-rank-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            font-size: 0.8rem;
            font-weight: 900;
            color: white;
            margin-left: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            font-family: 'Arial', sans-serif;
        }
        .rank-1 { background: linear-gradient(135deg, #FFD700, #FDB931); border: 1px solid #C5A000; color: #7a5c00; text-shadow: 0px 1px 0px rgba(255,255,255,0.4); }
        .rank-2 { background: linear-gradient(135deg, #E0E0E0, #BDBDBD); border: 1px solid #9E9E9E; color: #555; text-shadow: 0px 1px 0px rgba(255,255,255,0.4); }
        .rank-3 { background: linear-gradient(135deg, #CD7F32, #A0522D); border: 1px solid #8B4513; color: #fff; }
        .rank-other { background-color: #1e293b; border: 1px solid #0f172a; }

        /* Role Badge */
        .role-badge {
            background-color: #1e293b !important;
            color: #ffffff !important;
            font-weight: 700;
            font-size: 0.8rem;
            padding: 4px 10px;
            border-radius: 9999px;
            border: 1px solid #0f172a;
            display: inline-block;
            white-space: nowrap;
        }

        /* Branch Badge */
        .branch-badge {
            background-color: #0284c7; 
            color: #ffffff;
            font-weight: 700;
            font-size: 0.75rem;
            padding: 3px 10px;
            border-radius: 9999px;
            border: 1px solid #0369a1;
            display: inline-flex;
            align-items: center;
            white-space: nowrap;
            margin-left: 8px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        /* Seniority Badge */
        .seniority-badge {
            background-color: #f1f5f9;
            color: #475569;
            font-weight: 700;
            font-size: 0.75rem;
            padding: 3px 10px;
            border-radius: 9999px;
            border: 1px solid #cbd5e1;
            display: inline-flex;
            align-items: center;
            white-space: nowrap;
            margin-left: 8px;
        }
        
        /* Logo placeholder styling */
        .logo-img {
            max-height: 40px;
            width: auto;
            object-fit: contain;
        }
        
        /* Stat Box Rank Icon */
        .stat-box-rank {
            position: absolute;
            top: 4px;
            right: 4px;
            font-size: 1.2rem;
        }

        /* Filter Dropdown */
        .filter-dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 4px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            padding: 0.5rem;
            z-index: 50;
            min-width: 220px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- Icons ---
        const Icon = ({ icon, size = 18, className = "" }) => {
            const [svgHtml, setSvgHtml] = useState("");
            useEffect(() => {
                if (window.lucide && window.lucide.icons && window.lucide.icons[icon]) {
                    try {
                        const iconNode = window.lucide.icons[icon];
                        if (typeof iconNode.toSVG === 'function') {
                            setSvgHtml(iconNode.toSVG({ width: size, height: size, class: className }));
                        }
                    } catch (e) {}
                }
            }, [icon, size, className]);
            if (!svgHtml) return <span className={`inline-block w-[${size}px] h-[${size}px]`}></span>;
            return <span dangerouslySetInnerHTML={{ __html: svgHtml }} className="flex items-center justify-center" />;
        };

        // --- Constants ---
        const SENIORITY_RANGES = [
            { id: '0-1', label: '1Âπ¥‰ª•‰∏ã (Êñ∞‰∫∫)', min: 0, max: 1 },
            { id: '1-2', label: '1-2Âπ¥', min: 1, max: 2 },
            { id: '2-3', label: '2-3Âπ¥', min: 2, max: 3 },
            { id: '3-5', label: '3-5Âπ¥', min: 3, max: 5 },
            { id: '5-10', label: '5-10Âπ¥', min: 5, max: 10 },
            { id: '10+', label: '10Âπ¥‰ª•‰∏ä', min: 10, max: 999 }
        ];

        const METRIC_MAP = {
            "ÁáüÊî∂ÊúàÁõÆÊ®ô": "monthlyGoal", "ÁáüÊî∂ÊúàÈÅîÊàê": "monthlyAchieved", "ÁáüÊî∂ÈÅîÊàêÁéá": "achievedRate",
            "Áï∂ÊúàÈñãÂç°Ê•≠Á∏æ": "cardSales", "Áï∂ÊúàÈñãÂç°ÊØîÁéá": "cardRate",
            "Âà∞Â∫ó‰æÜÂÆ¢Êï∏": "totalVisits", "Âà∞Â∫óÊ∂àË≤ª‰∫∫Êï∏": "payingCustomers", "Âπ≥ÂùáÊàê‰∫§Áéá": "dealRate", "Á∏ΩÂπ≥ÂùáÂÆ¢ÂñÆ": "avgTicket",
            "Âà∞Â∫óÊñ∞ÂÆ¢Êï∏": "newVisits", "Êñ∞ÂÆ¢Êàê‰∫§Êï∏": "newDeals", "Êñ∞ÂÆ¢Êàê‰∫§Áéá": "newDealRate", "Êñ∞ÂÆ¢Ê∂àË≤ªÈáëÈ°ç": "newAmount", "Êñ∞ÂÆ¢Âπ≥ÂùáÂÆ¢ÂñÆ": "newAvgTicket",
            "Âà∞Â∫óËàäÂÆ¢Êï∏": "oldVisits", "ËàäÂÆ¢Êàê‰∫§Êï∏": "oldDeals", "ËàäÂÆ¢Êàê‰∫§Áéá": "oldDealRate", "ËàäÂÆ¢Ê∂àË≤ªÈáëÈ°ç": "oldAmount", "ËàäÂÆ¢Âπ≥ÂùáÂÆ¢ÂñÆ": "oldAvgTicket",
            "Áï∂ÊúàÊ∂àËÄóÈáëÈ°ç": "consumeAmount", "Áï∂ÊúàÊ∂àËÄó‰∫∫Êï∏": "consumePeople", "Áï∂ÊúàÂπ≥ÂùáÊ∂àËÄó": "consumeAvg",
            "Á∏ΩÈä∑ÂîÆÊ•≠Á∏æ": "totalSales", "Áï∂ÊúàÈä∑ÂîÆÊ•≠Á∏æ": "monthlySales", "‰øùÈ§ä/‰øùÂÅ•ÂìÅÈä∑ÂîÆÊ•≠Á∏æ": "productSales"
        };

        const RANK_METRICS = [
            'cardRate', 'dealRate', 'avgTicket', 'newDealRate', 'newAvgTicket', 'oldDealRate', 'oldAvgTicket'
        ];

        // --- Helpers ---
        const cleanNumber = (val) => {
            if (typeof val === 'number') return val;
            if (!val) return 0;
            if (typeof val === 'string') {
                let clean = val.replace(/,/g, '').trim();
                if (clean.includes('%')) return parseFloat(clean.replace('%', '')) * 100;
                return parseFloat(clean);
            }
            return 0;
        };

        const formatMoney = (num) => {
            if (num === undefined || num === null || isNaN(num)) return '-';
            return new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', minimumFractionDigits: 0 }).format(num);
        };

        const formatPercent = (num) => {
             if (num === undefined || num === null || isNaN(num)) return '-';
             return parseFloat(num).toFixed(1).replace(/\.0$/, '') + '%';
        }

        // --- SENIORITY CALCULATION (Enhanced 2.0) ---
        const calculateSeniorityInfo = (val) => {
            if (!val) return { text: "Êú™Áü•", years: 0 };
            const today = new Date('2026-02-11');
            let date;

            const strVal = String(val).trim();
            // Regex for YYYY-MM-DD or YYYY/MM/DD
            const dateMatch = strVal.match(/(\d{4})[-/.](\d{1,2})[-/.](\d{1,2})/);

            if (dateMatch) {
                const year = parseInt(dateMatch[1], 10);
                const month = parseInt(dateMatch[2], 10) - 1; 
                const day = parseInt(dateMatch[3], 10);
                date = new Date(year, month, day);
            } 
            else if (!isNaN(parseFloat(val)) && isFinite(val)) {
                if (parseFloat(val) > 20000) {
                     const serial = parseFloat(val);
                     date = new Date(Math.round((serial - 25569) * 86400 * 1000));
                }
            } else {
                date = new Date(strVal);
            }

            if (!date || isNaN(date.getTime())) return { text: "Êú™Áü•", years: 0 };

            let months = (today.getFullYear() - date.getFullYear()) * 12 + (today.getMonth() - date.getMonth());
            if (today.getDate() < date.getDate()) {
                months--;
            }
            
            if (months < 0) return { text: "Êú™Âà∞ËÅ∑", years: 0 };
            
            const y = Math.floor(months / 12);
            const m = months % 12;
            const text = y > 0 ? (m > 0 ? `${y}Âπ¥${m}ÂÄãÊúà` : `${y}Âπ¥`) : `${m}ÂÄãÊúà`;
            return { text: text, years: months / 12 };
        };

        // --- RANKING LOGIC ---
        const calculateRankings = (items, bottomThreshold = 3) => {
            if (!items || items.length === 0) return items;
            const rankedItems = items.map(item => ({ ...item, ranks: {} }));
            const count = rankedItems.length;

            RANK_METRICS.forEach(metric => {
                const sorted = [...rankedItems].sort((a, b) => (b.stats[metric] || 0) - (a.stats[metric] || 0));
                
                sorted.forEach((item, index) => {
                    const originalItem = rankedItems.find(ri => {
                        if (ri.name && item.name) {
                            return ri.name === item.name && ri.branch === item.branch;
                        }
                        return ri.branchName && ri.branchName === item.branchName;
                    });
                    
                    if (!originalItem) return;

                    if (index === 0) originalItem.ranks[metric] = 'top1';
                    else if (index === 1) originalItem.ranks[metric] = 'top2';
                    else if (index === 2) originalItem.ranks[metric] = 'top3';
                    
                    if (bottomThreshold > 0 && index >= count - bottomThreshold) {
                        if (!originalItem.ranks[metric]) {
                            originalItem.ranks[metric] = 'bottom';
                        }
                    }
                });
            });
            return rankedItems;
        };

        const calculateGlobalSalesRanks = (allBranchData) => {
            let allStaff = [];
            allBranchData.forEach(branch => {
                if (branch.staff) {
                    branch.staff.forEach(s => {
                        const sales = s.stats.totalSales || s.stats.monthlySales || 0;
                        allStaff.push({
                            ...s,
                            rawSales: sales,
                            branchName: branch.branchName 
                        });
                    });
                }
            });

            allStaff.sort((a, b) => b.rawSales - a.rawSales);

            const top10Map = {};
            allStaff.forEach((s, index) => {
                const key = `${s.name}_${s.branchName}`;
                top10Map[key] = index + 1;
            });

            return top10Map;
        };

        // --- EXCEL PARSING LOGIC ---
        const parseBranchSheet = (sheet) => {
            const data = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: null });
            if (!data || data.length < 3) return null;

            let headerIdx = -1;
            for(let i=0; i<Math.min(data.length, 20); i++) {
                if(JSON.stringify(data[i]).includes("202") || JSON.stringify(data[i]).includes("Âπ¥Â∫¶")) {
                    headerIdx = i;
                    break;
                }
            }
            if(headerIdx === -1) headerIdx = 1;

            const headerRow = data[headerIdx]; 
            const periods = [];
            const periodIndices = {};
            
            if(headerRow && Array.isArray(headerRow)) {
                headerRow.forEach((cell, idx) => {
                    if (cell && (String(cell).includes('202') || String(cell).includes('Âπ¥Â∫¶'))) {
                        const pName = String(cell).trim();
                        if (!periodIndices.hasOwnProperty(pName)) {
                            periods.push(pName);
                            periodIndices[pName] = idx;
                        }
                    }
                });
            }

            const branches = {};
            const branchOrder = []; 
            let currentBranch = null;

            for (let i = headerIdx + 1; i < data.length; i++) {
                const row = data[i];
                if (!row) continue;
                
                const colB = row[1]; 
                if (colB) {
                    currentBranch = String(colB).replace(/\r\n/g, '').replace(/\n/g, '').trim();
                    if (!branches[currentBranch]) {
                        branches[currentBranch] = {};
                        branchOrder.push(currentBranch);
                    }
                }

                const metricName = row[2]; 
                if (currentBranch && metricName && METRIC_MAP[metricName.trim()]) {
                    const key = METRIC_MAP[metricName.trim()];
                    periods.forEach(p => {
                        const idx = periodIndices[p];
                        const val = row[idx];
                        if (!branches[currentBranch][p]) branches[currentBranch][p] = {};
                        let numVal = cleanNumber(val);
                        if ((key.includes('Rate') || key.includes('ÊØîÁéá')) && Math.abs(numVal) <= 10.0 && numVal !== 0) {
                            numVal = numVal * 100;
                        }
                        branches[currentBranch][p][key] = numVal;
                    });
                }
            }
            
            Object.keys(branches).forEach(b => {
                Object.keys(branches[b]).forEach(p => {
                    const stats = branches[b][p];
                    if (stats.monthlyGoal && stats.monthlyAchieved) {
                        stats.achievedRate = (stats.monthlyAchieved / stats.monthlyGoal) * 100;
                    }
                });
            });

            return { branches, periods, branchOrder };
        };

        const parseStaffSheet = (sheet) => {
            const data = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: null });
            if (!data || data.length < 5) return null;

            let staffRowIdx = -1;
            for(let i=0; i<Math.min(data.length, 20); i++) {
                if(JSON.stringify(data[i]).includes("Â∫óÈï∑") || JSON.stringify(data[i]).includes("Ë´ÆË©¢")) {
                    staffRowIdx = i;
                    break;
                }
            }
            if(staffRowIdx === -1) staffRowIdx = 2; 

            const branchRowIdx = staffRowIdx - 1;
            const branchRow = data[branchRowIdx];
            const staffRow = data[staffRowIdx];
            const joinDateRow = data[staffRowIdx + 1]; 
            
            const staffList = [];
            const colToStaff = {}; 
            let currentBranch = null;

            if(Array.isArray(staffRow)) {
                for (let c = 0; c < staffRow.length; c++) {
                    if (branchRow && branchRow[c]) {
                        let bRaw = String(branchRow[c]);
                        if (bRaw.includes('\n')) bRaw = bRaw.split('\n')[0];
                        currentBranch = bRaw.trim();
                    }

                    const sRaw = staffRow[c];
                    if (sRaw && String(sRaw).includes('\n')) {
                        let name = String(sRaw);
                        let role = "‰∫∫Âì°";
                        
                        if (name.includes('-(')) {
                            const parts = name.split('-(');
                            name = parts[0].trim();
                            let rolePart = parts[1] || "";
                            rolePart = rolePart.replace(/^[A-Z0-9]+\)/, ''); 
                            role = rolePart.replace(/\n/g, '').trim();
                        } 
                        else if (name.includes('\n')) {
                            const parts = name.split('\n');
                            name = parts[0].trim();
                            role = parts[1].trim();
                        }

                        let seniorityInfo = { text: "Êú™Áü•", years: 0 };
                        if (joinDateRow && joinDateRow[c]) {
                            seniorityInfo = calculateSeniorityInfo(joinDateRow[c]);
                        }

                        if (name && currentBranch) {
                            colToStaff[c] = { 
                                name, role, branch: currentBranch, 
                                seniority: seniorityInfo.text, 
                                seniorityYears: seniorityInfo.years,
                                stats: {} 
                            };
                            staffList.push(colToStaff[c]);
                        }
                    }
                }
            }

            for (let i = staffRowIdx + 2; i < data.length; i++) {
                const row = data[i];
                if (!row) continue;
                const metricName = row[1]; 
                if (metricName && METRIC_MAP[metricName.trim()]) {
                    const key = METRIC_MAP[metricName.trim()];
                    Object.keys(colToStaff).forEach(colIdx => {
                        const val = row[colIdx];
                        let numVal = cleanNumber(val);
                        if ((key.includes('Rate') || key.includes('ÊØîÁéá')) && Math.abs(numVal) <= 10.0 && numVal !== 0) {
                            numVal = numVal * 100;
                        }
                        colToStaff[colIdx].stats[key] = numVal;
                    });
                }
            }
            return staffList;
        };

        // --- UI Components ---
        
        const RankIcon = ({ rank }) => {
            if (!rank) return null;
            let icon = null;
            if (rank === 'top1') icon = <span title="Á¨¨1Âêç" className="rank-icon">ü•á</span>;
            else if (rank === 'top2') icon = <span title="Á¨¨2Âêç" className="rank-icon">ü•à</span>;
            else if (rank === 'top3') icon = <span title="Á¨¨3Âêç" className="rank-icon">ü•â</span>;
            else if (rank === 'bottom') icon = <span title="ÈúÄÂä†Âº∑" className="rank-icon">‚ö†Ô∏è</span>;
            return icon;
        };

        const GlobalSalesRankIcon = ({ rank }) => {
            if (!rank) return null;
            let bgClass = "rank-other";
            if (rank === 1) bgClass = "rank-1";
            else if (rank === 2) bgClass = "rank-2";
            else if (rank === 3) bgClass = "rank-3";
            return <span className={`global-rank-badge ${bgClass}`}>{rank}</span>;
        };

        const StatBox = ({ label, value, isMoney, isPercent, highlight, rank }) => {
            let displayVal = value;
            if (isMoney) displayVal = formatMoney(value);
            if (isPercent) displayVal = formatPercent(value);
            const textColor = highlight ? "text-medical-800" : "text-slate-800";
            const bgColor = highlight ? "bg-medical-50 border-medical-200 shadow-sm" : "bg-white border-slate-100";

            return (
                <div className={`flex flex-col p-2 rounded border ${bgColor} h-full justify-center transition-colors relative`}>
                    <span className="metric-label">{label}</span>
                    <span className={`metric-value text-xl ${textColor}`}>{displayVal}</span>
                    {rank && <div className="absolute top-1 right-1"><RankIcon rank={rank} /></div>}
                </div>
            );
        };

        const RevenueProgress = ({ goal, achieved, rate }) => (
            <div className="bg-slate-50 p-4 rounded-lg border border-slate-200 mb-4">
                <div className="flex justify-between items-end mb-2">
                    <div className="flex flex-col">
                        <span className="text-sm font-bold text-slate-500">ÁáüÊî∂ÈÅîÊàêÁéá</span>
                        <span className={`text-3xl font-extrabold ${rate >= 100 ? 'text-green-600' : 'text-medical-600'}`}>
                            {formatPercent(rate)}
                        </span>
                    </div>
                    <div className="text-right">
                        <div className="text-xs text-slate-400 font-bold mb-0.5">ÈÅîÊàê / ÁõÆÊ®ô</div>
                        <div className="text-sm font-bold text-slate-600">
                            {formatMoney(achieved)} / {formatMoney(goal)}
                        </div>
                    </div>
                </div>
                <div className="w-full bg-slate-200 rounded-full h-2.5 overflow-hidden">
                    <div 
                        className={`h-full rounded-full transition-all duration-700 ${rate >= 100 ? 'bg-green-500' : 'bg-medical-500'}`} 
                        style={{ width: `${Math.min(rate, 100)}%` }}
                    ></div>
                </div>
            </div>
        );

        const NewOldList = ({ type, stats, ranks }) => {
            const isNew = type === 'new';
            const prefix = isNew ? 'new' : 'old';
            const title = isNew ? 'Êñ∞ÂÆ¢Ë°®Áèæ' : 'ËàäÂÆ¢Ë°®Áèæ';
            const icon = isNew ? 'UserPlus' : 'Users';
            const titleColor = isNew ? 'text-orange-700' : 'text-blue-700';
            const headerBorder = isNew ? 'border-orange-100' : 'border-blue-100';
            const valueColor = isNew ? 'text-orange-900' : 'text-blue-900';
            const blockBg = isNew ? 'bg-orange-50/30' : 'bg-blue-50/30'; 
            const blockBorder = isNew ? 'border-orange-100' : 'border-blue-100';

            return (
                <div className={`p-3 rounded-lg border ${blockBorder} ${blockBg} flex flex-col h-full`}>
                    <div className={`flex items-center text-base font-bold mb-3 ${titleColor} border-b ${headerBorder} pb-2`}>
                        <Icon icon={icon} size={18} className="mr-2"/> {title}
                    </div>
                    <div className="space-y-2 flex-1">
                        {[
                            { l: 'Âà∞Â∫óÊï∏', k: 'Visits', fmt: null },
                            { l: 'Êàê‰∫§Êï∏', k: 'Deals', fmt: null },
                            { l: 'Êàê‰∫§Áéá', k: 'DealRate', fmt: 'pct' },
                            { l: 'Ê∂àË≤ªÈáëÈ°ç', k: 'Amount', fmt: 'money', big: true },
                            { l: 'Âπ≥ÂùáÂÆ¢ÂñÆ', k: 'AvgTicket', fmt: 'money' }
                        ].map((item, i) => (
                            <div key={i} className="flex justify-between items-center">
                                <span className="text-xs font-bold text-slate-500">{item.l}</span>
                                <div className="flex items-center">
                                    <span className={`font-bold ${item.big ? 'text-lg' : 'text-sm'} ${valueColor}`}>
                                        {item.fmt === 'money' ? formatMoney(stats[prefix + item.k]) : 
                                         item.fmt === 'pct' ? formatPercent(stats[prefix + item.k]) : 
                                         stats[prefix + item.k]}
                                    </span>
                                    {/* Show rank if available for this metric */}
                                    {ranks && ranks[prefix + item.k] && <RankIcon rank={ranks[prefix + item.k]} />}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const StaffInfoRow = ({ label, value, isMoney, isPercent, highlightClass, rank, globalRank }) => (
            <div className="info-row">
                <span className="info-label">{label}</span>
                <div className="info-val-container">
                    <span className={`info-val ${highlightClass || 'text-slate-700'}`}>
                        {isPercent ? formatPercent(value) : (isMoney ? formatMoney(value) : value)}
                    </span>
                    {globalRank ? <GlobalSalesRankIcon rank={globalRank} /> : <RankIcon rank={rank} />}
                </div>
            </div>
        );

        const StaffCard = ({ staff, globalSalesRank, showBranch }) => {
            const { stats, ranks } = staff;
            return (
                <div className="bg-white rounded-lg shadow-sm border border-slate-200 p-5 mb-5 break-inside-avoid">
                    <div className="flex items-center mb-5 pb-3 border-b border-slate-100 flex-wrap gap-2">
                        <span className="text-2xl font-black text-slate-800 mr-2">{staff.name}</span>
                        <span className="role-badge shadow-sm">{staff.role}</span>
                        {showBranch && <span className="branch-badge shadow-sm"><Icon icon="MapPin" size={10} className="mr-1" />{staff.branch}</span>}
                        <span className="seniority-badge shadow-sm"><Icon icon="Clock" size={12} className="mr-1 text-slate-400" />{staff.seniority}</span>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                        <div className="bg-gray-50/50 p-3 rounded-lg border border-gray-100">
                            <div className="staff-section-title text-medical-600 border-medical-100">Èä∑ÂîÆÁãÄÊ≥Å</div>
                            <div className="pl-1">
                                <StaffInfoRow 
                                    label="Á∏ΩÈä∑ÂîÆÊ•≠Á∏æ" 
                                    value={stats.totalSales || stats.monthlySales} 
                                    isMoney 
                                    highlightClass="text-medical-700 text-lg" 
                                    globalRank={globalSalesRank}
                                />
                                <StaffInfoRow label="Âπ¥Â∫¶Èä∑ÂîÆÊ•≠Á∏æ" value={stats.monthlySales} isMoney />
                                <StaffInfoRow label="‰øùÈ§äÂìÅÊ•≠Á∏æ" value={stats.productSales} isMoney />
                                <StaffInfoRow label="Âπ¥Â∫¶ÈñãÂç°Ê•≠Á∏æ" value={stats.cardSales} isMoney />
                                <StaffInfoRow label="Âπ¥Â∫¶ÈñãÂç°ÊØîÁéá" value={stats.cardRate} isPercent rank={ranks?.cardRate} />
                            </div>
                        </div>
                        <div className="bg-gray-50/50 p-3 rounded-lg border border-gray-100">
                            <div className="staff-section-title text-slate-500 border-slate-200">È°ßÂÆ¢Âà∞Â∫ó</div>
                            <div className="pl-1">
                                <StaffInfoRow label="Âà∞Â∫ó‰æÜÂÆ¢Êï∏" value={stats.totalVisits} />
                                <StaffInfoRow label="Âà∞Â∫óÊ∂àË≤ª‰∫∫Êï∏" value={stats.payingCustomers} />
                                <StaffInfoRow label="Âπ≥ÂùáÊàê‰∫§Áéá" value={stats.dealRate} isPercent highlightClass="text-medical-700" rank={ranks?.dealRate}/>
                                <StaffInfoRow label="Á∏ΩÂπ≥ÂùáÂÆ¢ÂñÆ" value={stats.avgTicket} isMoney highlightClass="text-medical-700" rank={ranks?.avgTicket}/>
                            </div>
                        </div>
                        <div className="bg-orange-50/40 rounded-lg p-3 border border-orange-100">
                            <div className="flex items-center mb-2 font-bold text-orange-700 text-sm border-b border-orange-200 pb-1"><Icon icon="UserPlus" size={14} className="mr-1.5"/> Êñ∞ÂÆ¢Ë°®Áèæ</div>
                            <StaffInfoRow label="Âà∞Â∫óÊñ∞ÂÆ¢Êï∏" value={stats.newVisits} />
                            <StaffInfoRow label="Êñ∞ÂÆ¢Êàê‰∫§Êï∏" value={stats.newDeals} />
                            <StaffInfoRow label="Êñ∞ÂÆ¢Êàê‰∫§Áéá" value={stats.newDealRate} isPercent rank={ranks?.newDealRate}/>
                            <StaffInfoRow label="Êñ∞ÂÆ¢Ê∂àË≤ªÈáëÈ°ç" value={stats.newAmount} isMoney highlightClass="text-orange-800"/>
                            <StaffInfoRow label="Êñ∞ÂÆ¢Âπ≥ÂùáÂÆ¢ÂñÆ" value={stats.newAvgTicket} isMoney highlightClass="text-orange-800" rank={ranks?.newAvgTicket}/>
                        </div>
                         <div className="bg-blue-50/40 rounded-lg p-3 border border-blue-100">
                            <div className="flex items-center mb-2 font-bold text-blue-700 text-sm border-b border-blue-200 pb-1"><Icon icon="Users" size={14} className="mr-1.5"/> ËàäÂÆ¢Ë°®Áèæ</div>
                            <StaffInfoRow label="Âà∞Â∫óËàäÂÆ¢Êï∏" value={stats.oldVisits} />
                            <StaffInfoRow label="ËàäÂÆ¢Êàê‰∫§Êï∏" value={stats.oldDeals} />
                            <StaffInfoRow label="ËàäÂÆ¢Êàê‰∫§Áéá" value={stats.oldDealRate} isPercent rank={ranks?.oldDealRate}/>
                            <StaffInfoRow label="ËàäÂÆ¢Ê∂àË≤ªÈáëÈ°ç" value={stats.oldAmount} isMoney highlightClass="text-blue-800"/>
                            <StaffInfoRow label="ËàäÂÆ¢Âπ≥ÂùáÂÆ¢ÂñÆ" value={stats.oldAvgTicket} isMoney highlightClass="text-blue-800" rank={ranks?.oldAvgTicket}/>
                        </div>
                    </div>
                    <div className="bg-slate-50 rounded p-3 flex flex-wrap justify-between items-center border border-slate-200 mt-2">
                        <div className="flex items-center text-xs font-bold text-slate-500 ml-2"><Icon icon="TrendingDown" size={16} className="mr-2"/> Ë™≤Á®ãÊ∂àËÄó</div>
                        <div className="flex space-x-6 mr-4">
                            <div className="flex items-baseline"><span className="text-xs text-slate-400 mr-2">Âπ¥Â∫¶ÈáëÈ°ç</span><span className="text-sm font-black text-slate-800">{formatMoney(stats.consumeAmount)}</span></div>
                            <div className="flex items-baseline"><span className="text-xs text-slate-400 mr-2">‰∫∫Êï∏</span><span className="text-sm font-bold text-slate-800">{stats.consumePeople || 0}</span></div>
                            <div className="flex items-baseline"><span className="text-xs text-slate-400 mr-2">Âπ≥Âùá</span><span className="text-sm font-bold text-slate-800">{formatMoney(stats.consumeAvg)}</span></div>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [parsedData, setParsedData] = useState(null);
            const [availablePeriods, setAvailablePeriods] = useState(["ÁØÑ‰æãÊúà‰ªΩ"]);
            const [selectedPeriod, setSelectedPeriod] = useState("ÁØÑ‰æãÊúà‰ªΩ");
            const [activeBranchIndex, setActiveBranchIndex] = useState(0);
            const [logoUrl, setLogoUrl] = useState("logo.png");
            const [user, setUser] = useState(null);
            const [isSaving, setIsSaving] = useState(false);
            const [isPasswordModalOpen, setIsPasswordModalOpen] = useState(false);
            const [passwordInput, setPasswordInput] = useState("");
            const [passwordError, setPasswordError] = useState(false);
            const [lastUpdated, setLastUpdated] = useState("");

            // Filters
            const [availableRoles, setAvailableRoles] = useState([]);
            const [selectedRoles, setSelectedRoles] = useState([]);
            const [isRoleFilterOpen, setIsRoleFilterOpen] = useState(false);
            
            const [availableBranches, setAvailableBranches] = useState([]);
            const [selectedFilterBranches, setSelectedFilterBranches] = useState([]);
            const [isBranchFilterOpen, setIsBranchFilterOpen] = useState(false);
            
            const [rankRange, setRankRange] = useState('all');
            
            // NEW: Seniority Filters (Multi-select)
            const [selectedSeniorityRanges, setSelectedSeniorityRanges] = useState([]); // Default empty = ALL
            const [isSeniorityFilterOpen, setIsSeniorityFilterOpen] = useState(false);

            const fileInputRef = useRef(null);
            const dashboardRef = useRef(null);
            
            // Firebase
            useEffect(() => {
                if (window.auth) {
                    const initAuth = async () => {
                        if (window.__initial_auth_token) await window.signInWithCustomToken(window.auth, window.__initial_auth_token);
                        else await window.signInAnonymously(window.auth);
                    };
                    initAuth();
                    window.onAuthStateChanged(window.auth, (u) => setUser(u));
                }
            }, []);

            useEffect(() => {
                if (user && window.db) {
                    const docRef = window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'dashboard_save', 'main');
                    const unsubscribe = window.onSnapshot(docRef, (docSnap) => {
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            if (data.branchData && data.staffData) {
                                setParsedData(data);
                                setAvailablePeriods(data.periods);
                                if (data.lastUpdated) setLastUpdated(data.lastUpdated);
                                if (!data.periods.includes(selectedPeriod)) setSelectedPeriod(data.periods[data.periods.length - 1]);
                            }
                        }
                    });
                    return () => unsubscribe();
                }
            }, [user]);

            useEffect(() => {
                if (parsedData && parsedData.staffData) {
                    const roles = [...new Set(parsedData.staffData.map(s => s.role))].filter(Boolean);
                    setAvailableRoles(roles);
                    if (selectedRoles.length === 0) setSelectedRoles(roles);
                    
                    const branches = parsedData.branchData.branchOrder || Object.keys(parsedData.branchData.branches);
                    setAvailableBranches(branches);
                    if (selectedFilterBranches.length === 0) setSelectedFilterBranches(branches);
                    
                    if (selectedSeniorityRanges.length === 0) {
                        setSelectedSeniorityRanges(SENIORITY_RANGES.map(r => r.id));
                    }
                }
            }, [parsedData]);

            const activeData = useMemo(() => {
                if (!parsedData) return [{ branchName: "ÁØÑ‰æã-Âè∞ÂåóÊóóËâ¶Â∫ó", stats: {}, staff: [], ranks: {} }];

                const { branchData, staffData, periods } = parsedData;
                const branchNames = branchData.branchOrder && branchData.branchOrder.length > 0 
                    ? branchData.branchOrder : Object.keys(branchData.branches);

                // Global Data
                const allBranchStructure = branchNames.map(bName => ({
                    branchName: bName,
                    staff: staffData.filter(s => s.branch === bName)
                }));
                
                let allStaffFlat = [];
                allBranchStructure.forEach(b => {
                    b.staff.forEach(s => {
                        const sales = s.stats.totalSales || s.stats.monthlySales || 0;
                        allStaffFlat.push({ ...s, rawSales: sales, branchName: b.branchName });
                    });
                });
                allStaffFlat.sort((a, b) => b.rawSales - a.rawSales);
                
                const globalSalesRankMap = {};
                allStaffFlat.forEach((s, idx) => {
                    globalSalesRankMap[`${s.name}_${s.branchName}`] = idx + 1;
                });
                
                // Build Standard Tabs
                const branchList = branchNames.map(bName => ({
                    branchName: bName,
                    stats: branchData.branches[bName][selectedPeriod] || {}
                }));
                const rankedBranchList = calculateRankings(branchList, 1);

                const finalBranchTabs = rankedBranchList.map(branch => {
                    const myStaff = staffData.filter(s => s.branch === branch.branchName);
                    // Local Staff Ranking: Bottom 3
                    const rankedStaff = calculateRankings(myStaff, 3);
                    
                    const staffFinal = rankedStaff.map(s => {
                        const key = `${s.name}_${s.branch}`;
                        return { ...s, globalSalesRank: globalSalesRankMap[key] };
                    });
                    return { ...branch, staff: staffFinal, isGlobalRanking: false, isTotalOverview: false };
                });

                // Total Overview (Updated Rounding)
                const totalStats = { monthlyGoal: 0, monthlyAchieved: 0, cardSales: 0, totalVisits: 0, payingCustomers: 0, newVisits: 0, newDeals: 0, newAmount: 0, oldVisits: 0, oldDeals: 0, oldAmount: 0, consumeAmount: 0, consumePeople: 0 };
                branchList.forEach(b => {
                    const s = b.stats;
                    totalStats.monthlyGoal += s.monthlyGoal || 0;
                    totalStats.monthlyAchieved += s.monthlyAchieved || 0;
                    totalStats.cardSales += s.cardSales || 0;
                    totalStats.totalVisits += s.totalVisits || 0;
                    totalStats.payingCustomers += s.payingCustomers || 0;
                    totalStats.newVisits += s.newVisits || 0;
                    totalStats.newDeals += s.newDeals || 0;
                    totalStats.newAmount += s.newAmount || 0;
                    totalStats.oldVisits += s.oldVisits || 0;
                    totalStats.oldDeals += s.oldDeals || 0;
                    totalStats.oldAmount += s.oldAmount || 0;
                    totalStats.consumeAmount += s.consumeAmount || 0;
                    totalStats.consumePeople += s.consumePeople || 0;
                });

                const totalDerived = {
                    ...totalStats,
                    achievedRate: totalStats.monthlyGoal ? (totalStats.monthlyAchieved / totalStats.monthlyGoal) * 100 : 0,
                    // ROUNDING
                    cardRate: totalStats.monthlyAchieved ? Math.round((totalStats.cardSales / totalStats.monthlyAchieved) * 100) : 0,
                    dealRate: totalStats.totalVisits ? Math.round((totalStats.payingCustomers / totalStats.totalVisits) * 100) : 0,
                    avgTicket: totalStats.payingCustomers ? Math.round(totalStats.monthlyAchieved / totalStats.payingCustomers) : 0,
                    newDealRate: totalStats.newVisits ? Math.round((totalStats.newDeals / totalStats.newVisits) * 100) : 0,
                    newAvgTicket: totalStats.newDeals ? Math.round(totalStats.newAmount / totalStats.newDeals) : 0,
                    oldDealRate: totalStats.oldVisits ? Math.round((totalStats.oldDeals / totalStats.oldVisits) * 100) : 0,
                    oldAvgTicket: totalStats.oldDeals ? Math.round(totalStats.oldAmount / totalStats.oldDeals) : 0,
                    consumeAvg: totalStats.consumePeople ? Math.round(totalStats.consumeAmount / totalStats.consumePeople) : 0
                };
                
                const totalOverviewTab = { branchName: "ÁáüÈÅãÁ∏æÊïàÁ∏ΩË°®", isTotalOverview: true, isGlobalRanking: false, stats: totalDerived, staff: [], ranks: {} };

                // Global Ranking Tab
                const filteredGlobalStaff = allStaffFlat.filter(s => {
                    const roleMatch = selectedRoles.includes(s.role);
                    const branchMatch = selectedFilterBranches.includes(s.branchName);
                    const currentRank = globalSalesRankMap[`${s.name}_${s.branchName}`];
                    let rankMatch = rankRange === 'all' ? true : currentRank <= parseInt(rankRange);
                    let seniorityMatch = false;
                    if (selectedSeniorityRanges.length === 0 || selectedSeniorityRanges.length === SENIORITY_RANGES.length) seniorityMatch = true;
                    else {
                        const y = s.seniorityYears || 0;
                        seniorityMatch = selectedSeniorityRanges.some(rangeId => {
                            const range = SENIORITY_RANGES.find(r => r.id === rangeId);
                            if(!range) return false;
                            return y >= range.min && y < range.max;
                        });
                    }
                    return roleMatch && branchMatch && rankMatch && seniorityMatch;
                });
                
                const flatStaffForMetricRanking = filteredGlobalStaff.map(s => ({ name: s.name, branch: s.branchName, stats: s.stats, ranks: {} }));
                const dynamicGlobalMetricRanks = calculateRankings(flatStaffForMetricRanking, 5);
                const dynamicGlobalMetricRankMap = {};
                dynamicGlobalMetricRanks.forEach(s => { dynamicGlobalMetricRankMap[`${s.name}_${s.branch}`] = s.ranks; });

                const globalRankTab = {
                    branchName: "Ê•≠Âãô‰∫∫Âì°Á∏æÊïàÊéíÂêç",
                    isGlobalRanking: true,
                    isTotalOverview: false,
                    stats: null,
                    staff: filteredGlobalStaff.map(s => {
                        const key = `${s.name}_${s.branchName}`;
                        return { ...s, branch: s.branchName, globalSalesRank: globalSalesRankMap[key], ranks: dynamicGlobalMetricRankMap[key] || {} };
                    })
                };

                return [...finalBranchTabs, totalOverviewTab, globalRankTab];

            }, [parsedData, selectedPeriod, selectedRoles, selectedFilterBranches, rankRange, selectedSeniorityRanges]);

            const activeBranch = activeData[activeBranchIndex] || activeData[0];

            // Handlers...
            const handleImportClick = () => { setIsPasswordModalOpen(true); setPasswordInput(""); setPasswordError(false); };
            const handlePasswordSubmit = (e) => { e.preventDefault(); if (passwordInput === "8888") { setIsPasswordModalOpen(false); if(fileInputRef.current) fileInputRef.current.click(); } else { setPasswordError(true); } };
            const handleFileUpload = (e) => { 
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (evt) => {
                    try {
                        const wb = XLSX.read(evt.target.result, { type: 'binary' });
                        if (wb.SheetNames.length < 2) throw new Error("Ë´ãÁ¢∫Ë™ç Excel ÂåÖÂê´Â∑•‰ΩúË°®1(ÂàÜÂ∫ó)ËàáÂ∑•‰ΩúË°®2(‰∫∫Âì°)");
                        const branchParsed = parseBranchSheet(wb.Sheets[wb.SheetNames[0]]);
                        const staffParsed = parseStaffSheet(wb.Sheets[wb.SheetNames[1]]);
                        
                        if (branchParsed && staffParsed) {
                            const nowStr = new Date().toLocaleString('zh-TW');
                            const newData = { branchData: branchParsed, staffData: staffParsed, periods: branchParsed.periods, lastUpdated: nowStr };
                            setParsedData(newData);
                            setAvailablePeriods(branchParsed.periods);
                            setLastUpdated(nowStr);
                            setSelectedPeriod(branchParsed.periods[branchParsed.periods.length - 1]);
                            setActiveBranchIndex(0);

                            if (user && window.db) {
                                setIsSaving(true);
                                try {
                                    const docRef = window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'dashboard_save', 'main');
                                    await window.setDoc(docRef, JSON.parse(JSON.stringify(newData)));
                                    alert("Ë≥áÊñôÂ∑≤ÂêåÊ≠•Ëá≥Èõ≤Á´ØÔºÅ");
                                } catch (err) { console.error(err); alert("Èõ≤Á´ØÂêåÊ≠•Â§±Êïó"); } finally { setIsSaving(false); }
                            }
                        } else { throw new Error("Ê†ºÂºèËÆÄÂèñÂ§±Êïó"); }
                    } catch (err) { alert("ËÆÄÂèñÈåØË™§: " + err.message); }
                };
                reader.readAsBinaryString(file);
            };
            const handleExportImage = async () => { 
                if (dashboardRef.current) {
                    const canvas = await html2canvas(dashboardRef.current, { scale: 2, backgroundColor: '#f8fafc', useCORS: true, windowWidth: 1920 });
                    const link = document.createElement('a');
                    link.download = `${activeBranch.branchName}_${selectedPeriod}_ÁáüÈÅãÁ∏æÊïà.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                }
            };
            const toggleRole = (role) => { if (selectedRoles.includes(role)) setSelectedRoles(selectedRoles.filter(r => r !== role)); else setSelectedRoles([...selectedRoles, role]); };
            const toggleAllRoles = () => { if (selectedRoles.length === availableRoles.length) setSelectedRoles([]); else setSelectedRoles(availableRoles); };
            const toggleBranch = (branch) => { if (selectedFilterBranches.includes(branch)) setSelectedFilterBranches(selectedFilterBranches.filter(b => b !== branch)); else setSelectedFilterBranches([...selectedFilterBranches, branch]); };
            const toggleAllBranches = () => { if (selectedFilterBranches.length === availableBranches.length) setSelectedFilterBranches([]); else setSelectedFilterBranches(availableBranches); };
            const toggleSeniority = (rangeId) => { if (selectedSeniorityRanges.includes(rangeId)) setSelectedSeniorityRanges(selectedSeniorityRanges.filter(r => r !== rangeId)); else setSelectedSeniorityRanges([...selectedSeniorityRanges, rangeId]); };
            const toggleAllSeniority = () => { if (selectedSeniorityRanges.length === SENIORITY_RANGES.length) setSelectedSeniorityRanges([]); else setSelectedSeniorityRanges(SENIORITY_RANGES.map(r => r.id)); };

            if (!activeBranch) return <div className="p-10 text-center">Ë≥áÊñôËºâÂÖ•‰∏≠...</div>;

            return (
                <div className="min-h-screen pb-10 font-sans text-slate-800">
                    <header className="bg-white border-b border-slate-200 sticky top-0 z-50 shadow-sm">
                        <div className="container mx-auto px-4 h-16 flex justify-between items-center">
                            <div className="flex items-center space-x-3">
                                <img src={logoUrl} alt="Logo" className="logo-img h-10 w-auto" onError={(e) => { e.target.style.display = 'none'; e.target.nextSibling.style.display = 'flex'; }} />
                                <div className="bg-medical-600 text-white p-1.5 rounded-lg shadow-sm" style={{display: 'none'}}><Icon icon="Activity" size={24} /></div>
                                <h1 className="text-xl font-black tracking-tight text-slate-800 hidden md:block">ÁáüÈÅãÂπ¥Â∫¶Á∏æÊïà</h1>
                                {lastUpdated && <span className="text-xs text-slate-400 ml-2 pt-1 font-bold">ÊúÄÂæåÊõ¥Êñ∞: {lastUpdated}</span>}
                                <div className="hidden lg:flex items-center ml-4 px-3 py-1 rounded-full text-xs font-bold bg-slate-100 text-slate-500">
                                    {isSaving ? <><span className="w-2 h-2 rounded-full bg-blue-500 animate-pulse mr-2"></span> ‰∏äÂÇ≥‰∏≠...</> : user ? <><span className="w-2 h-2 rounded-full bg-green-500 mr-2"></span> Èõ≤Á´ØÂ∑≤ÈÄ£Á∑ö</> : <><span className="w-2 h-2 rounded-full bg-gray-400 mr-2"></span> Èõ¢Á∑öÊ®°Âºè</>}
                                </div>
                            </div>
                            <div className="flex items-center space-x-3">
                                <div className="flex items-center bg-slate-50 rounded-lg px-2 py-1.5 border border-slate-200">
                                    <span className="text-xs text-slate-400 font-bold mr-2 uppercase hidden sm:inline">Period</span>
                                    <select value={selectedPeriod} onChange={(e) => setSelectedPeriod(e.target.value)} className="bg-transparent font-bold text-sm outline-none cursor-pointer text-medical-800">
                                        {availablePeriods.map(p => <option key={p} value={p}>{p}</option>)}
                                    </select>
                                </div>
                                <button onClick={handleImportClick} className="bg-white hover:bg-slate-50 text-slate-600 border border-slate-200 px-3 py-1.5 rounded-lg text-sm font-bold flex items-center transition shadow-sm"><Icon icon="Upload" size={16} className="mr-1.5" /> ÂåØÂÖ•</button>
                                <input type="file" ref={fileInputRef} className="hidden" onChange={handleFileUpload} accept=".xlsx,.xls"/>
                                <button onClick={handleExportImage} className="bg-medical-600 hover:bg-medical-700 text-white px-3 py-1.5 rounded-lg text-sm font-bold flex items-center shadow transition transform hover:-translate-y-0.5"><Icon icon="Camera" size={16} className="mr-1.5" /> Êà™Âúñ</button>
                            </div>
                        </div>
                        <div className="bg-slate-50 border-b border-slate-200">
                            <div className="container mx-auto px-4 flex space-x-2 overflow-x-auto scrollbar-hide py-1">
                                {activeData.map((branch, idx) => (
                                    <button key={idx} onClick={() => setActiveBranchIndex(idx)}
                                        className={`py-2 px-4 text-sm font-bold rounded-t-lg transition-all whitespace-nowrap ${idx === activeBranchIndex ? 'bg-white text-medical-700 border-t-4 border-medical-500 shadow-sm' : 'text-slate-400 hover:text-slate-600 hover:bg-slate-100'} ${branch.isGlobalRanking ? 'bg-amber-50 text-amber-700 border-amber-500' : ''} ${branch.isTotalOverview ? 'bg-blue-50 text-blue-700 border-blue-500' : ''}`}>
                                        {branch.isGlobalRanking && <Icon icon="Trophy" size={14} className="mr-1 inline-block" />}
                                        {branch.isTotalOverview && <Icon icon="BarChart3" size={14} className="mr-1 inline-block" />}
                                        {branch.branchName}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </header>

                    <main className="container mx-auto px-4 py-6 max-w-[1400px]" id="dashboard-container" ref={dashboardRef}>
                        <div className="mb-4 flex items-center justify-between border-b border-slate-200 pb-2">
                             <div className="flex items-baseline">
                                <h2 className="text-3xl font-black text-slate-800 tracking-tight mr-3">{activeBranch.branchName}</h2>
                                {activeBranch.isGlobalRanking ? <span className="text-lg font-bold text-slate-400">({activeBranch.staff.length})</span> : <span className="text-lg font-bold text-slate-400">ÁáüÈÅãÁ∏ΩË¶Ω</span>}
                             </div>
                             
                             {activeBranch.isGlobalRanking && (
                                <div className="flex space-x-2">
                                    <div className="relative">
                                        <button onClick={() => { setIsBranchFilterOpen(!isBranchFilterOpen); setIsRoleFilterOpen(false); setIsSeniorityFilterOpen(false); }} className="flex items-center px-3 py-2 bg-white border border-slate-300 rounded-lg text-sm font-bold text-slate-700 hover:bg-slate-50 shadow-sm"><Icon icon="MapPin" size={16} className="mr-2"/> ÂàÜÂ∫ó ({selectedFilterBranches.length})</button>
                                        {isBranchFilterOpen && (
                                            <div className="filter-dropdown-menu">
                                                <div className="flex items-center justify-between mb-2 pb-2 border-b border-slate-100"><span className="text-xs font-bold text-slate-500">ÈÅ∏ÊìáÂàÜÂ∫ó</span><button onClick={toggleAllBranches} className="text-xs text-medical-600 font-bold hover:underline">{selectedFilterBranches.length === availableBranches.length ? 'ÂèñÊ∂à' : 'ÂÖ®ÈÅ∏'}</button></div>
                                                <div className="space-y-1">{availableBranches.map(b => (<label key={b} className="flex items-center px-2 py-1.5 hover:bg-slate-50 rounded cursor-pointer"><input type="checkbox" checked={selectedFilterBranches.includes(b)} onChange={() => toggleBranch(b)} className="rounded border-slate-300 text-medical-600 focus:ring-medical-500 mr-2"/><span className="text-sm text-slate-700 font-medium">{b}</span></label>))}</div>
                                            </div>
                                        )}
                                    </div>
                                    <div className="relative">
                                        <button onClick={() => { setIsRoleFilterOpen(!isRoleFilterOpen); setIsBranchFilterOpen(false); setIsSeniorityFilterOpen(false); }} className="flex items-center px-3 py-2 bg-white border border-slate-300 rounded-lg text-sm font-bold text-slate-700 hover:bg-slate-50 shadow-sm"><Icon icon="Filter" size={16} className="mr-2"/> ËÅ∑Á®± ({selectedRoles.length})</button>
                                        {isRoleFilterOpen && (
                                            <div className="filter-dropdown-menu">
                                                <div className="flex items-center justify-between mb-2 pb-2 border-b border-slate-100"><span className="text-xs font-bold text-slate-500">ÈÅ∏ÊìáËÅ∑Á®±</span><button onClick={toggleAllRoles} className="text-xs text-medical-600 font-bold hover:underline">{selectedRoles.length === availableRoles.length ? 'ÂèñÊ∂à' : 'ÂÖ®ÈÅ∏'}</button></div>
                                                <div className="space-y-1">{availableRoles.map(role => (<label key={role} className="flex items-center px-2 py-1.5 hover:bg-slate-50 rounded cursor-pointer"><input type="checkbox" checked={selectedRoles.includes(role)} onChange={() => toggleRole(role)} className="rounded border-slate-300 text-medical-600 focus:ring-medical-500 mr-2"/><span className="text-sm text-slate-700 font-medium">{role}</span></label>))}</div>
                                            </div>
                                        )}
                                    </div>
                                    <div className="relative">
                                        <button onClick={() => { setIsSeniorityFilterOpen(!isSeniorityFilterOpen); setIsBranchFilterOpen(false); setIsRoleFilterOpen(false); }} className="flex items-center px-3 py-2 bg-white border border-slate-300 rounded-lg text-sm font-bold text-slate-700 hover:bg-slate-50 shadow-sm"><Icon icon="Clock" size={16} className="mr-2"/> Âπ¥Ë≥á ({selectedSeniorityRanges.length})</button>
                                        {isSeniorityFilterOpen && (
                                            <div className="filter-dropdown-menu">
                                                <div className="flex items-center justify-between mb-2 pb-2 border-b border-slate-100"><span className="text-xs font-bold text-slate-500">ÈÅ∏ÊìáÂπ¥Ë≥á</span><button onClick={toggleAllSeniority} className="text-xs text-medical-600 font-bold hover:underline">{selectedSeniorityRanges.length === SENIORITY_RANGES.length ? 'ÂèñÊ∂à' : 'ÂÖ®ÈÅ∏'}</button></div>
                                                <div className="space-y-1">{SENIORITY_RANGES.map(range => (<label key={range.id} className="flex items-center px-2 py-1.5 hover:bg-slate-50 rounded cursor-pointer"><input type="checkbox" checked={selectedSeniorityRanges.includes(range.id)} onChange={() => toggleSeniority(range.id)} className="rounded border-slate-300 text-medical-600 focus:ring-medical-500 mr-2"/><span className="text-sm text-slate-700 font-medium">{range.label}</span></label>))}</div>
                                            </div>
                                        )}
                                    </div>
                                    <div className="relative">
                                        <div className="flex items-center bg-white border border-slate-300 rounded-lg px-3 py-2 shadow-sm">
                                            <Icon icon="ListOrdered" size={16} className="mr-2 text-slate-500"/>
                                            <select value={rankRange} onChange={(e) => setRankRange(e.target.value)} className="bg-transparent font-bold text-sm outline-none cursor-pointer text-slate-700">
                                                <option value="all">ÂÖ®ÈÉ®ÊéíÂêç</option>
                                                <option value="10">Top 10</option>
                                                <option value="20">Top 20</option>
                                                <option value="30">Top 30</option>
                                                <option value="40">Top 40</option>
                                                <option value="50">Top 50</option>
                                                <option value="100">Top 100</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                             )}
                        </div>

                        {!activeBranch.isGlobalRanking && (
                             <>
                                <div className="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-4">
                                    <div className="stat-card">
                                        <div className="card-header border-l-4 border-l-medical-500"><Icon icon="BadgeDollarSign" className="mr-2 text-medical-600"/> ÁáüÊî∂ÁãÄÊ≥Å</div>
                                        <div className="card-content flex flex-col justify-between">
                                            <RevenueProgress goal={activeBranch.stats.monthlyGoal} achieved={activeBranch.stats.monthlyAchieved} rate={activeBranch.stats.achievedRate} />
                                            <div className="grid grid-cols-2 gap-3">
                                                <StatBox label="ÈñãÂç°Ê•≠Á∏æ" value={activeBranch.stats.cardSales} isMoney />
                                                <StatBox label="ÈñãÂç°ÊØîÁéá" value={activeBranch.stats.cardRate} isPercent rank={activeBranch.ranks?.cardRate} />
                                            </div>
                                        </div>
                                    </div>
                                    <div className="stat-card">
                                        <div className="card-header border-l-4 border-l-slate-500"><Icon icon="Store" className="mr-2 text-slate-600"/> È°ßÂÆ¢Âà∞Â∫ó</div>
                                        <div className="card-content grid grid-cols-2 gap-3">
                                            <StatBox label="Âà∞Â∫ó‰æÜÂÆ¢Êï∏" value={activeBranch.stats.totalVisits} />
                                            <StatBox label="Âà∞Â∫óÊ∂àË≤ª‰∫∫Êï∏" value={activeBranch.stats.payingCustomers} />
                                            <StatBox label="Âπ≥ÂùáÊàê‰∫§Áéá" value={activeBranch.stats.dealRate} isPercent highlight rank={activeBranch.ranks?.dealRate} />
                                            <StatBox label="Á∏ΩÂπ≥ÂùáÂÆ¢ÂñÆ" value={activeBranch.stats.avgTicket} isMoney highlight rank={activeBranch.ranks?.avgTicket} />
                                        </div>
                                    </div>
                                    <div className="stat-card">
                                        <div className="card-header border-l-4 border-l-orange-400"><Icon icon="Users" className="mr-2 text-orange-500"/> Êñ∞ËàäÂÆ¢ÂàÜÊûê</div>
                                        <div className="card-content grid grid-cols-2 gap-3 p-0">
                                            <NewOldList type="new" stats={activeBranch.stats} ranks={activeBranch.ranks} />
                                            <NewOldList type="old" stats={activeBranch.stats} ranks={activeBranch.ranks} />
                                        </div>
                                    </div>
                                </div>
                                <div className="bg-white rounded-lg shadow-sm border border-slate-200 p-3 mb-8 flex flex-wrap justify-between items-center">
                                     <div className="flex items-center text-slate-700 font-bold ml-2"><Icon icon="TrendingDown" size={20} className="mr-2 text-slate-400"/> Ë™≤Á®ãÊ∂àËÄóÁãÄÊ≥Å</div>
                                     <div className="flex space-x-8 mr-4 text-sm">
                                        <div className="flex items-baseline"><span className="text-slate-400 mr-2 font-bold">Áï∂ÊúàÊ∂àËÄó</span><span className="text-xl font-bold text-slate-800">{formatMoney(activeBranch.stats.consumeAmount)}</span></div>
                                        <div className="flex items-baseline"><span className="text-slate-400 mr-2 font-bold">‰∫∫Êï∏</span><span className="text-xl font-bold text-slate-800">{activeBranch.stats.consumePeople || 0}</span></div>
                                        <div className="flex items-baseline"><span className="text-slate-400 mr-2 font-bold">Âπ≥Âùá</span><span className="text-xl font-bold text-slate-800">{formatMoney(activeBranch.stats.consumeAvg)}</span></div>
                                     </div>
                                </div>
                            </>
                        )}

                        {!activeBranch.isTotalOverview && (
                            <div className="flex items-center mb-6">
                                <h3 className="text-xl font-black text-slate-700 mr-4">
                                    {activeBranch.isGlobalRanking ? "ÂÖ®È´îÊ•≠ÂãôÁ∏æÊïàÊéíË°å (‰æùÁ∏ΩÈä∑ÂîÆÊ•≠Á∏æ)" : "Âπ¥Â∫¶‰∫∫Âì°Á∏æÊïà"}
                                </h3>
                                <div className="h-px bg-slate-200 flex-1"></div>
                            </div>
                        )}

                        {!activeBranch.isTotalOverview && (
                            <div>
                                {activeBranch.staff && activeBranch.staff.map((member, idx) => (
                                    <StaffCard 
                                        key={idx} 
                                        staff={member} 
                                        globalSalesRank={member.globalSalesRank}
                                        showBranch={activeBranch.isGlobalRanking} 
                                    />
                                ))}
                                {(!activeBranch.staff || activeBranch.staff.length === 0) && (
                                    <div className="p-8 text-center bg-white rounded-lg border-2 border-dashed border-slate-300">
                                        <p className="text-lg text-slate-400 font-bold">Êö´ÁÑ°‰∫∫Âì°Ë≥áÊñô</p>
                                    </div>
                                )}
                            </div>
                        )}
                    </main>

                    {isPasswordModalOpen && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] backdrop-blur-sm">
                            <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm transform transition-all scale-100 border border-gray-200">
                                <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center"><Icon icon="Lock" size={20} className="mr-2 text-medical-600"/>ÁÆ°ÁêÜÂì°È©óË≠â</h3>
                                <p className="text-sm text-gray-500 mb-4">Ë´ãËº∏ÂÖ•ÂØÜÁ¢º‰ª•ÈÄ≤Ë°åË≥áÊñôÂåØÂÖ•Êìç‰Ωú„ÄÇ</p>
                                <form onSubmit={handlePasswordSubmit}>
                                    <input type="password" autoFocus value={passwordInput} onChange={(e) => { setPasswordInput(e.target.value); setPasswordError(false); }} placeholder="Ë´ãËº∏ÂÖ•ÂØÜÁ¢º" className={`w-full border rounded-lg px-4 py-2 outline-none focus:ring-2 mb-2 ${passwordError ? 'border-red-500 focus:ring-red-200' : 'border-gray-300 focus:ring-medical-200'}`}/>
                                    {passwordError && <p className="text-xs text-red-500 mb-2 font-bold flex items-center"><Icon icon="AlertCircle" size={12} className="mr-1"/>ÂØÜÁ¢ºÈåØË™§ÔºåË´ãÈáçË©¶„ÄÇ</p>}
                                    <div className="flex justify-end space-x-2 mt-4">
                                        <button type="button" onClick={() => setIsPasswordModalOpen(false)} className="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg text-sm font-bold">ÂèñÊ∂à</button>
                                        <button type="submit" className="px-4 py-2 bg-medical-600 hover:bg-medical-700 text-white rounded-lg text-sm font-bold shadow-md transition-transform active:scale-95">Á¢∫Ë™ç</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    <footer className="text-center text-slate-400 text-xs py-8 border-t border-slate-200 bg-white mt-8 font-bold">
                        ÁáüÈÅãÂπ¥Â∫¶Á∏æÊïà &copy; 2026 ÁæéÂä†ÈÜ´Áæé MEGAIA
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>